# 火山引擎端到端实时语音大模型集成指南

## 概述

本项目现已集成火山引擎端到端实时语音大模型API，提供两种语音交互方案：

1. **端到端实时语音大模型** (推荐，默认)
2. **传统RTC + ASR + TTS + LLM方案**

## 功能特性

### 端到端实时语音大模型方案
- ✅ 直接语音到语音处理，延迟更低
- ✅ 配置简单，只需App ID和Access Key
- ✅ 流式交互，实时反馈
- ✅ 支持语音打断
- ✅ 内置安全审核
- ✅ 支持多种音频格式输出

### 传统RTC方案
- ✅ 精细控制ASR、TTS、LLM参数
- ✅ 灵活的服务组合
- ✅ 适合复杂业务场景

## 使用步骤

### 1. 配置端到端语音服务

1. 进入 **Playground** 页面
2. 在左侧选择 **配置** 标签
3. 在顶部选择 **端到端语音** 标签
4. 填写必要配置：
   - **App ID**: 语音大模型应用的唯一标识符
   - **Access Key**: 访问密钥，用于身份验证

### 2. 高级配置 (可选)

点击 **高级设置** 可配置：
- **连接ID**: 用于问题排查的追踪标识
- **机器人名称**: AI助手的显示名称
- **严格审核**: 内容审核等级
- **TTS输出格式**: OGG Opus (推荐) 或 PCM
- **音频参数**: 采样率和声道数 (仅PCM格式)

### 3. 开始语音对话

1. 在左侧选择 **语音** 标签
2. 点击 **连接服务** 建立WebSocket连接
3. 点击 **开始会话** 初始化语音会话
4. 点击 **开始录音** 开始语音输入
5. 与AI进行实时语音对话

### 4. 方案切换

- 在语音界面顶部可以随时切换语音方案
- 选择 **端到端实时语音大模型** 或 **RTC传统方案**
- 配置会自动保存

## 界面说明

### 状态指示器
- **连接状态**: WebSocket连接状态
- **会话状态**: 语音会话状态  
- **录音状态**: 麦克风录音状态
- **AI状态**: AI处理状态 (空闲/思考中/说话中)

### 实时交互区域
- **实时语音识别**: 显示用户正在说的话
- **AI实时回复**: 显示AI的文本回复
- **快速文本输入**: 预设的快速文本消息

### 聊天记录
- 完整的对话历史记录
- 支持音频播放 (当有音频时)
- 实时状态更新
- 临时消息标识

## API文档参考

端到端实时语音大模型基于火山引擎官方API：
- [端到端实时语音大模型API接入文档](https://www.volcengine.com/docs/6561/1594356)

## 技术架构

### WebSocket二进制协议
- 完整实现火山引擎二进制协议规范
- 支持音频数据流式传输
- 事件驱动的消息处理

### 状态管理
- 使用Jotai进行响应式状态管理
- 支持实时状态更新
- 错误处理和恢复

### 音频处理
- 支持PCM 16kHz单声道输入
- 自动格式转换
- 支持OGG Opus和PCM输出

## 故障排除

### 常见问题

1. **连接失败**
   - **错误**: `App ID and Access Key are required for connection`
     - **解决**: 请在配置页面的"端到端语音"标签中填写正确的App ID和Access Key
   - **错误**: `WebSocket connection error`
     - **解决**: 检查网络连接，确认App ID和Access Key有效
     - **解决**: 确认使用HTTPS协议访问页面
   - **错误**: `WebSocket error: {}`
     - **解决**: 通常是认证失败，请检查App ID和Access Key是否正确
     - **解决**: 确认已在火山引擎控制台开通端到端语音服务

2. **无法录音**
   - 检查浏览器麦克风权限
   - 确认使用HTTPS协议
   - 尝试刷新页面重新授权

3. **音频无声音**
   - 检查系统音量设置
   - 确认浏览器音频播放权限
   - 尝试切换TTS输出格式

4. **延迟较高**
   - 检查网络延迟
   - 尝试减少录音数据发送间隔
   - 切换到更快的网络环境

### 调试工具

项目内置了丰富的调试工具：
- **调试标签**: 查看详细的系统状态
- **错误诊断**: 自动检测配置问题
- **模块测试**: 独立测试各个功能模块

## 开发说明

### 新增组件
- `RealtimeVoiceClient`: 核心WebSocket客户端
- `UnifiedVoiceCall`: 统一的语音通话界面
- `RealtimeChatHistory`: 端到端语音聊天记录
- `realtimeVoiceStateAtom`: 端到端语音状态管理

### 核心文件
- `/lib/realtime-voice-service.ts`: 端到端语音服务封装
- `/store/realtime-voice-state.ts`: 状态管理
- `/components/unified-voice-call.tsx`: 统一界面组件
- `/components/chat/realtime-chat-history.tsx`: 聊天历史组件

### 配置迁移
项目会自动迁移旧的配置到新的端到端语音方案，确保向后兼容。

## 更新日志

### v1.0.4 (当前版本)
- ✅ 集成火山引擎端到端实时语音大模型API
- ✅ 实现WebSocket二进制协议
- ✅ 支持语音方案切换
- ✅ 新增统一语音通话界面
- ✅ 实现端到端语音状态管理
- ✅ 扩展配置系统支持端到端语音
- ✅ 完善错误处理和类型安全

---

如有问题，请查看项目README或提交Issue。